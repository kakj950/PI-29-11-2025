---
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install flask pytest

      - name: ğŸ—ƒï¸ Prepare database
        run: |
          mkdir -p ../..
          sqlite3 ../../Base.md << 'SQL'
          CREATE TABLE IF NOT EXISTS tasks (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              title TEXT NOT NULL,
              deadline TEXT,
              priority TEXT,
              category TEXT,
              user_id TEXT,
              completed_at TEXT,
              reminder_time TEXT
          );
          SQL

      - name: ğŸ“ Create minimal templates directory
        run: |
          mkdir -p templates
          echo '<!DOCTYPE html>' > templates/tasks_list.html
          echo '<html>' >> templates/tasks_list.html
          echo '<body>' >> templates/tasks_list.html
          echo '    <h1>Tasks ({{ stats.total }} total)</h1>' >> templates/tasks_list.html
          echo '    <ul>' >> templates/tasks_list.html
          echo '    {% for task in tasks %}' >> templates/tasks_list.html
          echo '        <li>{{ task.title }} ({{ task.completed_at }})</li>' >> templates/tasks_list.html
          echo '    {% endfor %}' >> templates/tasks_list.html
          echo '    </ul>' >> templates/tasks_list.html
          echo '</body>' >> templates/tasks_list.html
          echo '</html>' >> templates/tasks_list.html

      - name: ğŸ“ Ensure app.py exists
        run: test -f app.py || { echo "âŒ File app.py not found in root!"; exit 1; }

      - name: ğŸ§ª Run tests
        run: python -c "import sys; sys.path.insert(0, '.'); from app import app; app.config['TESTING'] = True; client = app.test_client(); rv = client.get('/'); assert rv.status_code == 200, f'Expected 200, got {rv.status_code}'; print('âœ… GET / -> 200 OK')"

      - name: ğŸ¯ Success
        if: success()
        run: echo "ğŸ‰ CI passed: app starts and serves /"