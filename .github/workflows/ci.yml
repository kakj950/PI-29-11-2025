name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install flask pytest

      - name: ğŸ—ƒï¸ Prepare database
        run: |
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ ĞºĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ² Ğ¸ Ğ‘Ğ” Ğ² Ğ½ÑƒĞ¶Ğ½Ğ¾Ğ¼ Ğ¼ĞµÑÑ‚Ğµ
          mkdir -p ../..
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ñ„Ğ°Ğ¹Ğ» Base.md ĞºĞ°Ğº SQLite-Ğ±Ğ°Ğ·Ñƒ (Ğ´Ğ°, Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğµ .md â€” Ğ½Ğ¾ ÑÑ‚Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ SQLite)
          sqlite3 ../../Base.md <<SQL
          CREATE TABLE IF NOT EXISTS tasks (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              title TEXT NOT NULL,
              deadline TEXT,
              priority TEXT,
              category TEXT,
              user_id TEXT,
              completed_at TEXT,
              reminder_time TEXT
          );
          SQL

      - name: ğŸ“ Create minimal templates directory
        run: |
          mkdir -p templates
          cat > templates/tasks_list.html <<'EOF'
          <!DOCTYPE html>
          <html>
          <body>
              <h1>Tasks ({{ stats.total }} total)</h1>
              <ul>
              {% for task in tasks %}
                  <li>{{ task.title }} ({{ task.completed_at }})</li>
              {% endfor %}
              </ul>
          </body>
          </html>
          EOF

      - name: ğŸ“ Ensure app.py exists
        run: test -f app.py || { echo "âŒ File app.py not found in root!"; exit 1; }

      - name: ğŸ§ª Run tests
        run: |
          # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ‚ÑƒÑ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ: Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ»Ğ¸ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ€Ñ‚Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸ Ğ¾Ñ‚Ğ´Ğ°Ñ‚ÑŒ /
          python -c "
import sys
sys.path.insert(0, '.')
from app import app
app.config['TESTING'] = True
client = app.test_client()
rv = client.get('/')
assert rv.status_code == 200, f'Expected 200, got {rv.status_code}'
print('âœ… GET / -> 200 OK')
          "

      - name: ğŸ¯ Success
        if: success()
        run: echo "ğŸ‰ CI passed: app starts and serves /"