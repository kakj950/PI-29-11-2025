---
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install flask pytest

      - name: Prepare database
        run: |
          mkdir -p ../..
          sqlite3 ../../Base.md << 'SQL'
          CREATE TABLE IF NOT EXISTS tasks (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              title TEXT NOT NULL,
              deadline TEXT,
              priority TEXT,
              category TEXT,
              user_id TEXT,
              completed_at TEXT,
              reminder_time TEXT
          );
          SQL

      - name: Create templates directory
        run: |
          mkdir -p templates
          echo '<!DOCTYPE html>' > templates/tasks_list.html
          echo '<html>' >> templates/tasks_list.html
          echo '<body>' >> templates/tasks_list.html
          echo '    <h1>Tasks</h1>' >> templates/tasks_list.html
          echo '    <ul>' >> templates/tasks_list.html
          echo '    {% for task in tasks %}' >> templates/tasks_list.html
          echo '        <li>{{ task.title }}</li>' >> templates/tasks_list.html
          echo '    {% endfor %}' >> templates/tasks_list.html
          echo '    </ul>' >> templates/tasks_list.html
          echo '</body>' >> templates/tasks_list.html
          echo '</html>' >> templates/tasks_list.html

      - name: Check app.py exists
        run: test -f test/app.py || { echo "File app.py not found"; exit 1; }

      - name: Run basic test
        run: python -c "import sys; sys.path.insert(0, '.'); from app import app; app.config['TESTING'] = True; client = app.test_client(); rv = client.get('/'); assert rv.status_code == 200, 'GET / failed'; print('GET / -> 200 OK')"

      - name: Final success message
        if: success()
        run: echo "CI passed"